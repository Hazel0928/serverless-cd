extend: ./s.base.yaml

services:
  worker:
    component: fc
    actions:
      post-deploy:
        - component: fc api UpdateFunction --region ${vars.region} --header '{"x-fc-disable-container-reuse":"True"}' --path '{"serviceName":"${vars.service.name}","functionName":"${vars.workerFunctionName}"}'
    props:
      region: ${vars.region}
      service: ${vars.service}
      function:
        name: ${vars.workerFunctionName}
        description: 执行用户配置的 CD 流程。
        runtime: nodejs14
        codeUri: ../worker
        handler: index.handler
        memorySize: 640
        timeout: 600
        environmentVariables:
          CD_PIPLINE_YAML: ${env.CD_PIPLINE_YAML}
          DOWNLOAD_CODE_DIR: ${env.DOWNLOAD_CODE_DIR}
          ACCESS_KEY_ID: ${env.ACCESS_KEY_ID}
          ACCESS_KEY_SECRET: ${env.ACCESS_KEY_SECRET}
          OSS_BUCKET: ${env.OSS_BUCKET}
          REGION: ${env.REGION}
          OTS_INSTANCE_NAME: ${env.OTS_INSTANCE_NAME}
          OTS_TASK_TABLE_NAME: ${env.OTS_TASK_TABLE_NAME}
          OTS_TASK_INDEX_NAME: ${env.OTS_TASK_INDEX_NAME}
          OTS_APP_TABLE_NAME: ${env.OTS_APP_TABLE_NAME}
          OTS_APP_INDEX_NAME: ${env.OTS_APP_INDEX_NAME}
        asyncConfiguration:
          maxAsyncEventAgeInSeconds: 456
          maxAsyncRetryAttempts: 0
          statefulInvocation: true
