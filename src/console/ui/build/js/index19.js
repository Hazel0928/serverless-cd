import{C as e,_ as t,d as a,e as n,M as s,f as r,i,R as o,j as l,N as p,P as d,K as c,p as u,v as m,r as x,a as y,l as f,b as g}from"./index.js";import{D as h,b as v,d as E}from"./task.js";import{P as b}from"./index3.js";import{C as k,R as C}from"./CancelDeploy.js";import{N}from"./index7.js";import{N as K}from"./index5.js";import"./index6.js";import"./index10.js";import"./index11.js";var S,I,P=(I=S=function(e){function d(){var t,r,i;a(this,d);for(var o=arguments.length,l=Array(o),p=0;p<o;p++)l[p]=arguments[p];return t=r=n(this,e.call.apply(e,[this].concat(l))),r.onKeyDown=function(e){var t;if(e.keyCode===s.SPACE){var a=r.props.onClick;e.preventDefault(),a&&a(e)}},n(r,i=t)}return t(d,e),d.prototype.render=function e(){var t,a,n=this.props,s=n.title,d=n.children,c=n.className,u=n.isExpanded,m=n.disabled,x=n.style,y=n.prefix,f=n.onClick,g=n.id,h=r(n,["title","children","className","isExpanded","disabled","style","prefix","onClick","id"]),v=i(((t={})[y+"collapse-panel"]=!0,t[y+"collapse-panel-hidden"]=!u,t[y+"collapse-panel-expanded"]=u,t[y+"collapse-panel-disabled"]=m,t[c]=c,t)),E=i(((a={})[y+"collapse-panel-icon"]=!0,a[y+"collapse-panel-icon-expanded"]=u,a)),b=g?g+"-heading":void 0,k=g?g+"-region":void 0;return o.createElement("div",l({className:v,style:x,id:g},h),o.createElement("div",{id:b,className:y+"collapse-panel-title",onClick:f,onKeyDown:this.onKeyDown,tabIndex:"0","aria-disabled":m,"aria-expanded":u,"aria-controls":k,role:"button"},o.createElement(p,{type:"arrow-right",className:E,"aria-hidden":"true"}),s),o.createElement("div",{className:y+"collapse-panel-content",role:"region",id:k},d))},d}(o.Component),S.propTypes={prefix:d.string,style:d.object,children:d.any,isExpanded:d.bool,disabled:d.bool,title:d.node,className:d.string,onClick:d.func,id:d.string},S.defaultProps={prefix:"next-",isExpanded:!1,onClick:c.noop},S.isNextPanel=!0,I);P.displayName="Panel";var w=e.config(P),j,D,z=(D=j=function(e){function s(t){a(this,s);var r=n(this,e.call(this,t)),i=void 0;return i="expandedKeys"in t?t.expandedKeys:t.defaultExpandedKeys,r.state={expandedKeys:void 0===i?[]:i},r}return t(s,e),s.getDerivedStateFromProps=function e(t){return"expandedKeys"in t?{expandedKeys:void 0===t.expandedKeys?[]:t.expandedKeys}:null},s.prototype.onItemClick=function e(t){var a=this.state.expandedKeys;if(this.props.accordion)a=String(a[0])===String(t)?[]:[t];else{a=[].concat(a);var n=String(t),s=a.findIndex((function(e){return String(e)===n})),r;s>-1?a.splice(s,1):a.push(t)}this.setExpandedKey(a)},s.prototype.genratePanelId=function e(t,a){var n=this.props.id,s=void 0;return t?s=t:n&&(s=n+"-panel-"+a),s},s.prototype.getProps=function e(t,a,n){var s=this,r=this.state.expandedKeys,i=t.title,o=this.props.disabled;o||(o=t.disabled);var l=!1;l=this.props.accordion?String(r[0])===String(n):r.some((function(e){return null!=e&&null!=n&&(e===n||e.toString()===n.toString())}));var p=this.genratePanelId(t.id,a);return{key:n,title:i,isExpanded:l,disabled:o,id:p,onClick:o?null:function(){s.onItemClick(n),"onClick"in t&&t.onClick(n)}}},s.prototype.getItemsByDataSource=function e(){var t=this,a,n=this.props.dataSource,s=n.some((function(e){return"key"in e}));return n.map((function(e,a){var n=s?e.key:""+a;return o.createElement(w,l({},t.getProps(e,a,n),{key:n}),e.content)}))},s.prototype.getItemsByChildren=function e(){var t=this,a=o.Children.map(this.props.children,(function(e){return e&&e.key})),n=Boolean(a&&a.length);return o.Children.map(this.props.children,(function(e,a){if(e&&"function"==typeof e.type&&e.type.isNextPanel){var s=n?e.key:""+a;return o.cloneElement(e,t.getProps(e.props,a,s))}return e}))},s.prototype.setExpandedKey=function e(t){"expandedKeys"in this.props||this.setState({expandedKeys:t}),this.props.onExpand(this.props.accordion?t[0]:t)},s.prototype.render=function e(){var t,a=this.props,n=a.prefix,r=a.className,p=a.style,d=a.disabled,c=a.dataSource,u=a.id,x=a.rtl,y=i(((t={})[n+"collapse"]=!0,t[n+"collapse-disabled"]=d,t[r]=Boolean(r),t)),f=m.pickOthers(s.propTypes,this.props);return o.createElement("div",l({id:u,className:y,style:p},f,{role:"presentation",dir:x?"rtl":void 0}),c?this.getItemsByDataSource():this.getItemsByChildren())},s}(o.Component),j.propTypes={prefix:d.string,style:d.object,dataSource:d.array,defaultExpandedKeys:d.array,expandedKeys:d.array,onExpand:d.func,disabled:d.bool,className:d.string,accordion:d.bool,children:d.node,id:d.string,rtl:d.bool},j.defaultProps={accordion:!1,prefix:"next-",onExpand:c.noop},j.contextTypes={prefix:d.string},D);z.displayName="Collapse";var B=u(e.config(z));B.Panel=w;var L="";const R=B.Panel,T=({step:e,isRequest:t})=>{const{status:a,run:n,process_time:s}=e,r=f.exports.get(h[a],"icon"),i=f.exports.get(h[a],"color");return o.createElement("div",{className:"flex-r pr-16",style:{width:"100%"}},o.createElement("span",null,o.createElement("span",{style:{marginRight:10}},t&&o.createElement(p,{type:"loading",size:"small",style:{position:"absolute",left:16}}),o.createElement(p,{type:r,className:`${i}`,size:"small"})),n),s&&o.createElement("span",{className:"flex-r",style:{minWidth:60}},o.createElement("i",{className:"iconfont icon-process-time mr-8",style:{fontSize:16}}),s,"s"))},$=undefined,_=({match:{params:{appId:e,taskId:t}}})=>{const[a,n]=x.exports.useState([]),[s,r]=x.exports.useState([]),[i,l]=x.exports.useState(!1),[p,d]=x.exports.useState(!0),c=y(v,{pollingInterval:5e3});x.exports.useEffect((()=>{l(!0),c.request({taskId:t})}),[t]),x.exports.useEffect((()=>{if(!c.data)return;l(!1);const e=["pending","running"],t=f.exports.map(f.exports.get(c.data,"steps",[]),((e,t)=>{var n;return{...e,rawLog:(null==(n=a[t])?void 0:n.rawLog)||"",initialize:!0,loading:!1}}));e.includes(f.exports.get(c.data,"status"))||(d(!1),c.cancel()),n(t)}),[c.data]);const u=(e,s)=>{if("running"===s)return;const r=a[e];r&&!r.rawLog?(r.loading=!0,n([...a]),E({taskId:t,stepCount:r.stepCount}).then((t=>{r.rawLog=t,r.loading=!1,r.initialize=!1,n([...a]),m(e)}))):m(e)},m=e=>{s.includes(e)?r(f.exports.filter(s,(t=>t!==e))):(s.push(e),r([...s]))},h=a=>{var n;null==(n=g)||n.replace(`/application/${e}/detail/${a||t}`)};return o.createElement(b,{title:"\u90e8\u7f72\u8be6\u60c5",description:f.exports.get(c,"data.message",""),breadcrumbExtra:p?o.createElement(k,{taskId:t,appId:e,repoName:f.exports.get(c.data,"repo_name",""),refreshCallback:h}):o.createElement(C,{disabled:p,taskId:t,appId:e,repoName:f.exports.get(c.data,"repo_name",""),refreshCallback:h}),breadcrumbs:[{name:"\u5e94\u7528\u5217\u8868",path:"/"},{name:e,path:`/application/${e}/detail`},{name:t}]},o.createElement(K,{visible:i,style:{width:"100%"}},o.createElement(B,{className:"task-collaps",expandedKeys:s},f.exports.map(a,((e,t)=>{const{initialize:a,loading:n,rawLog:s,status:r}=e,i=undefined,l=["pending","skipped","cancelled"].includes(r),p="running"===r,d=a&&n&&!s;return o.createElement(R,{className:"task-details-panel "+(l||p||d?"task-details-panel-loading":""),title:o.createElement(T,{step:e,isRequest:d}),disabled:l,onClick:()=>u(t,r)},o.createElement(K,{visible:n,style:{width:"100%"}},o.createElement(N.TextArea,{className:"task-details-textarea",rows:15,value:s||"\u6b63\u5728\u52a0\u8f7d\u4e2d"})))})))))};export{_ as default};
